# 인증 및 API Key 정책

하모니 스마트팜 솔루션의 인증 시스템과 API Key 관리 정책을 설명합니다.

## 개요

하모니 스마트팜은 두 가지 인증 방식을 지원합니다:

1. **JWT 인증**: 웹 UI 접근용 (사용자 로그인)
2. **API Key 인증**: OPEN API 접근용 (프로그래밍 방식)

## JWT 인증

### 로그인

사용자는 사용자명과 비밀번호로 로그인하여 JWT 토큰을 받습니다.

**엔드포인트**: `POST /api/auth/login`

**요청 예시**:
```json
{
  "username": "admin",
  "password": "password123"
}
```

**응답 예시**:
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": 1,
    "username": "admin",
    "email": "admin@example.com",
    "role": "admin"
  }
}
```

### 토큰 사용

인증이 필요한 API 요청 시 `Authorization` 헤더에 토큰을 포함합니다:

```bash
curl -H "Authorization: Bearer YOUR_TOKEN" \
  http://localhost:3001/api/sensors
```

### 토큰 갱신

토큰이 만료되면 `refreshToken`을 사용하여 새 토큰을 발급받을 수 있습니다.

**엔드포인트**: `POST /api/auth/token/refresh`

**요청 예시**:
```json
{
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

## API Key 인증

### API Key 발급

1. 웹 UI에서 로그인
2. "API 키" 메뉴로 이동
3. "API 키 생성" 버튼 클릭
4. 키 이름과 권한(Scopes) 설정
5. 생성된 키를 안전한 곳에 저장

**중요**: API Key는 생성 시 한 번만 표시됩니다. 반드시 안전한 곳에 저장하세요.

### API Key 사용

API Key를 사용하여 API에 접근할 수 있습니다:

```bash
curl -H "x-api-key: sk_your_api_key_here" \
  http://localhost:3001/api/sensors
```

### API Key 관리

- **조회**: `GET /api/openapi/keys` (인증 필요)
- **생성**: `POST /api/openapi/keys` (인증 필요)
- **비활성화**: `POST /api/openapi/keys/:id/deactivate` (인증 필요)
- **삭제**: `DELETE /api/openapi/keys/:id` (인증 필요)

### API Key Quota

각 API Key는 일일 사용량 제한(quota)이 있습니다:

- 기본값: 1,000 요청/일
- 매일 자정에 자동으로 리셋
- Quota 초과 시 `429 Too Many Requests` 응답

### Scopes (권한)

API Key에 부여할 수 있는 권한:

- `read:sensors` - 센서 데이터 읽기
- `read:actuators` - 액추에이터 상태 읽기
- `write:control` - 액추에이터 제어
- `read:datasets` - 데이터셋 읽기
- `write:datasets` - 데이터셋 쓰기

Scopes를 지정하지 않으면 전체 권한이 부여됩니다.

## 보안 정책

### 비밀번호

- 비밀번호는 SHA-256으로 해시되어 저장됩니다
- 프로덕션 환경에서는 더 강력한 해싱 알고리즘(bcrypt) 사용 권장

### API Key

- API Key는 `sk_` 접두사로 시작하는 64자리 16진수 문자열입니다
- 데이터베이스에는 해시된 값만 저장됩니다
- 원본 키는 생성 시 한 번만 표시됩니다

### 토큰 만료

- Access Token: 기본 1시간 (환경 변수로 설정 가능)
- Refresh Token: 기본 7일 (환경 변수로 설정 가능)

## 감사 로그 (Audit Logs)

모든 중요한 작업은 감사 로그에 기록됩니다:

- 로그인/로그아웃
- API Key 생성/삭제/비활성화
- 규칙 변경
- 펌웨어 배포
- 기타 관리 작업

**엔드포인트**: `GET /api/audit/logs` (관리자 권한 필요)

## 환경 변수

백엔드 `.env` 파일에 다음 변수를 설정할 수 있습니다:

```env
JWT_SECRET=your-secret-key-change-in-production
JWT_REFRESH_SECRET=your-refresh-secret-key-change-in-production
JWT_EXPIRES_IN=1h
JWT_REFRESH_EXPIRES_IN=7d
```

## 예시: curl을 사용한 API 호출

### JWT 토큰으로 인증

```bash
# 1. 로그인
TOKEN=$(curl -X POST http://localhost:3001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"password123"}' \
  | jq -r '.token')

# 2. 인증된 요청
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:3001/api/sensors
```

### API Key로 인증

```bash
curl -H "x-api-key: sk_your_api_key_here" \
  http://localhost:3001/api/sensors
```

## 관련 문서

- [API Key 관리 UI](./components/Auth/APIKeyCard.mdx)
- [계정 페이지](./pages/account/api-keys.mdx)
- [RBAC 권한 관리](./rbac/roles.mdx)

